services:
  api:
    image: rms-shopify-integration:latest
    container_name: rms-shopify-api
    ports:
      - "8000:8000"
    environment:
      # Application Configuration
      - ENVIRONMENT=production
      - DEBUG=False
      - LOG_LEVEL=INFO
      
      # RMS Database Configuration
      - RMS_DB_HOST=${RMS_DB_HOST:-host.docker.internal}
      - RMS_DB_PORT=${RMS_DB_PORT:-1438}
      - RMS_DB_NAME=${RMS_DB_NAME:-bb57}
      - RMS_DB_USER=${RMS_DB_USER:-Shop1fy5428}
      - RMS_DB_PASSWORD=${RMS_DB_PASSWORD:-sh0pqfy10736!}
      - RMS_DB_DRIVER=${RMS_DB_DRIVER:-ODBC Driver 17 for SQL Server}
      - RMS_CONNECTION_TIMEOUT=${RMS_CONNECTION_TIMEOUT:-60}
      
      # Shopify Configuration
      - SHOPIFY_SHOP_URL=${SHOPIFY_SHOP_URL}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN}
      - SHOPIFY_API_VERSION=${SHOPIFY_API_VERSION:-2025-04}
      - SHOPIFY_WEBHOOK_SECRET=${SHOPIFY_WEBHOOK_SECRET}
      
      # Redis Configuration (optional)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      
      # Synchronization Settings
      - ENABLE_SCHEDULED_SYNC=${ENABLE_SCHEDULED_SYNC:-True}
      - SYNC_INTERVAL_MINUTES=${SYNC_INTERVAL_MINUTES:-5}
      - SYNC_BATCH_SIZE=${SYNC_BATCH_SIZE:-100}
      - ENABLE_ZERO_STOCK_CLEANUP=${ENABLE_ZERO_STOCK_CLEANUP:-True}

      # Full Sync Schedule (una vez al d√≠a a las 2am Costa Rica)
      - ENABLE_FULL_SYNC_SCHEDULE=${ENABLE_FULL_SYNC_SCHEDULE:-True}
      - FULL_SYNC_HOUR=${FULL_SYNC_HOUR:-2}
      - FULL_SYNC_MINUTE=${FULL_SYNC_MINUTE:-0}
      - FULL_SYNC_TIMEZONE=${FULL_SYNC_TIMEZONE:-America/Costa_Rica}

      # Order Synchronization (PRIMARY METHOD - Order Polling)
      - ENABLE_ORDER_POLLING=${ENABLE_ORDER_POLLING:-True}
      - ORDER_POLLING_INTERVAL_MINUTES=${ORDER_POLLING_INTERVAL_MINUTES:-10}
      - ORDER_POLLING_LOOKBACK_MINUTES=${ORDER_POLLING_LOOKBACK_MINUTES:-15}
      - ORDER_POLLING_BATCH_SIZE=${ORDER_POLLING_BATCH_SIZE:-50}
      - ORDER_POLLING_MAX_PAGES=${ORDER_POLLING_MAX_PAGES:-10}
      - SHIPPING_ITEM_ID=${SHIPPING_ITEM_ID:-481461}

      # Webhooks (OPTIONAL BACKUP - disabled by default)
      - ENABLE_WEBHOOKS=${ENABLE_WEBHOOKS:-False}

      # Order Filtering (applies to both polling and webhooks)
      - ALLOWED_ORDER_FINANCIAL_STATUSES=${ALLOWED_ORDER_FINANCIAL_STATUSES:-PAID,PARTIALLY_PAID,AUTHORIZED,PENDING}

      # Guest Customer Configuration
      - ALLOW_ORDERS_WITHOUT_CUSTOMER=${ALLOW_ORDERS_WITHOUT_CUSTOMER:-True}
      - GUEST_CUSTOMER_ACCOUNT_NUMBER=${GUEST_CUSTOMER_ACCOUNT_NUMBER:-SHOPIFY-GUEST}
      - REQUIRE_CUSTOMER_EMAIL=${REQUIRE_CUSTOMER_EMAIL:-False}

    volumes:
      - ./logs:/app/logs
    
    networks:
      - app-network
    
    depends_on:
      - redis
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dashboard:
    image: rms-shopify-integration:latest
    container_name: rms-shopify-dashboard
    ports:
      - "8501:8501"
    environment:
      # Dashboard Configuration
      - DASHBOARD_API_URL=http://api:8000
      - DEBUG=${DEBUG:-False}

      # Streamlit Configuration
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

    volumes:
      - ./logs:/app/logs

    networks:
      - app-network

    depends_on:
      - api
      - redis

    restart: unless-stopped

    command: ["streamlit", "run", "dashboard/main.py", "--server.port=8501", "--server.address=0.0.0.0"]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  redis:
    image: redis:7-alpine
    container_name: rms-shopify-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: unless-stopped
    command: redis-server --appendonly yes

networks:
  app-network:
    driver: bridge

volumes:
  redis-data:
