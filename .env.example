# RMS Database Configuration
RMS_DB_HOST=190.106.75.222
RMS_DB_PORT=1438
RMS_DB_NAME=BB57
RMS_DB_USER=Shop1fy5428
RMS_DB_PASSWORD=sh0pqfy10736!
RMS_DB_DRIVER=ODBC Driver 17 for SQL Server

# Shopify Configuration
SHOPIFY_SHOP_URL=your-store.myshopify.com
SHOPIFY_ACCESS_TOKEN=your-shopify-access-token
SHOPIFY_API_VERSION=2024-01
SHOPIFY_WEBHOOK_SECRET=your-webhook-secret

# Application Configuration
APP_NAME=RMS-Shopify Integration
APP_VERSION=0.1.0
ENVIRONMENT=development
DEBUG=True
HOST=0.0.0.0
PORT=8000
WORKERS=1
LOG_LEVEL=INFO

# Redis Configuration (optional)
REDIS_URL=redis://localhost:6379

# Security
SECRET_KEY=your-secret-key-change-in-production
ALLOWED_HOSTS=localhost,127.0.0.1
API_BASE_URL=https://your-production-api.com
STAGING_URL=https://your-staging-api.com

# Synchronization Settings
ENABLE_SCHEDULED_SYNC=True
SYNC_INTERVAL_MINUTES=5
SYNC_BATCH_SIZE=25
SYNC_CHECKPOINT_INTERVAL=100
SYNC_MAX_CONCURRENT_JOBS=3

# Zero-Stock Variant Cleanup
# Automatically delete variants from Shopify when they have Quantity=0 in RMS
# This keeps your store inventory clean and accurate
ENABLE_ZERO_STOCK_CLEANUP=True

# Scheduled Full Sync Settings (una vez al día a las 2am Costa Rica)
ENABLE_FULL_SYNC_SCHEDULE=True
FULL_SYNC_HOUR=2
FULL_SYNC_MINUTE=0
FULL_SYNC_TIMEZONE=America/Costa_Rica
# FULL_SYNC_DAYS=0,1,2,3,4,5,6  # Optional: specify days (0=Monday, 6=Sunday)

# Rate Limiting
ENABLE_RATE_LIMITING=True
RATE_LIMIT_PER_MINUTE=60

# Logging
LOG_FILE_PATH=logs/app.log
LOG_MAX_SIZE_MB=10
LOG_BACKUP_COUNT=5

# Metrics and Monitoring
METRICS_ENABLED=True
HEALTH_CHECK_TIMEOUT=10

# Email Alerts (optional)
ALERT_EMAIL_ENABLED=False
ALERT_EMAIL_SMTP_HOST=smtp.gmail.com
ALERT_EMAIL_SMTP_PORT=587
ALERT_EMAIL_FROM=alerts@yourcompany.com
ALERT_EMAIL_TO=admin@yourcompany.com
ALERT_EMAIL_PASSWORD=your-email-password

# Order Synchronization Settings
# Control which order financial statuses are allowed for sync to RMS
# Valid statuses: PENDING, AUTHORIZED, PARTIALLY_PAID, PAID, PARTIALLY_REFUNDED, REFUNDED, VOIDED
# Default: PAID,PARTIALLY_PAID,AUTHORIZED,PENDING
# ALLOWED_ORDER_FINANCIAL_STATUSES=PAID,PARTIALLY_PAID,AUTHORIZED,PENDING
#
# Business Logic:
# - PENDING: Orders awaiting payment (recommended for full visibility)
# - AUTHORIZED: Payment authorized but not captured
# - PARTIALLY_PAID: Orders with partial payment received
# - PAID: Orders fully paid (conservative approach)
# - PARTIALLY_REFUNDED: Orders with partial refunds
# - REFUNDED: Fully refunded orders
# - VOIDED: Canceled/voided orders

# Guest Customer Configuration
# Allow orders without customer data (guest checkout)
ALLOW_ORDERS_WITHOUT_CUSTOMER=True
# Optional: Use a specific RMS customer ID for all guest orders (manual setup required)
# If not set, system will auto-create/find guest customer with GUEST_CUSTOMER_ACCOUNT_NUMBER
# Fallback stub ID if customer table not available: 9111
DEFAULT_CUSTOMER_ID_FOR_GUEST_ORDERS=9111
# Account number for auto-created guest customer in RMS (default: SHOPIFY-GUEST)
GUEST_CUSTOMER_ACCOUNT_NUMBER=SHOPIFY-GUEST
# Require customer email for all orders
REQUIRE_CUSTOMER_EMAIL=False

# ═══════════════════════════════════════════════════════════════════════════════
# ORDER SYNCHRONIZATION SYSTEM (Shopify → RMS)
# ═══════════════════════════════════════════════════════════════════════════════

# === PRIMARY METHOD: Order Polling (RECOMMENDED) ===
# Order Polling is the PRIMARY and RECOMMENDED method for syncing orders from Shopify to RMS.
# Advantages over webhooks:
# ✓ More reliable (automatic retry logic)
# ✓ Better observability (full statistics and metrics)
# ✓ Built-in deduplication (prevents duplicate orders in RMS)
# ✓ Can fetch historical orders (not just real-time)
# ✓ Resilient to network issues (Shopify won't retry failed webhooks)
# ✓ Full control over sync timing and frequency

ENABLE_ORDER_POLLING=True
# Polling interval in minutes (how often to check for new orders)
ORDER_POLLING_INTERVAL_MINUTES=10
# Lookback window in minutes (how far back to search for orders each cycle)
# Recommended: slightly longer than interval to ensure no orders are missed
ORDER_POLLING_LOOKBACK_MINUTES=15
# Orders per page in GraphQL query (max 250, recommended 50 for balance)
ORDER_POLLING_BATCH_SIZE=50
# Maximum pages to fetch per polling cycle (prevents runaway queries)
ORDER_POLLING_MAX_PAGES=10

# === ORDERENTRY FOR SHIPPING COSTS ===
# ItemID from VIEW_Items to use for automatic shipping cost OrderEntry records
# This item will be used to create OrderEntry records for shipping charges
# Default: 481461 (shipping item in RMS database)
SHIPPING_ITEM_ID=481461

# === ORDER UPDATE & CANCELLATION DETECTION ===
# The polling system now uses 'updated_at' instead of 'created_at' to detect BOTH:
# ✓ New orders (just created)
# ✓ Edited orders (quantity changed, address updated, etc.)
# ✓ Cancelled orders (marked with cancelledAt in Shopify)
#
# Behavior:
# - New orders → Created in RMS
# - Edited orders → Updated in RMS (same order ID)
# - Cancelled orders → Marked as Closed=1 in RMS with cancellation reason
# - Cancelled + Not in RMS → Skipped (won't create cancelled orders)
#
# This means every polling cycle will:
# 1. Fetch orders updated in last X minutes (ORDER_POLLING_LOOKBACK_MINUTES)
# 2. Check which ones exist in RMS
# 3. Create new orders, update existing orders, or mark as cancelled
#
# Statistics will show: newly_synced (created), updated, and sync_errors

# === OPTIONAL: Webhooks (BACKUP METHOD) ===
# Webhooks can be enabled as a complement to polling for instant order sync.
# However, polling alone is sufficient for most use cases (10-minute sync delay).
# Disable this if you prefer simpler system with only one sync method.
ENABLE_WEBHOOKS=False

# Tax Discrimination Settings (Optional)
# Default tax percentage for Costa Rica IVA if not found in RMS
# DEFAULT_TAX_PERCENTAGE=13
#
# Maximum allowed price difference percentage between RMS and Shopify
# If difference exceeds this threshold, use Shopify's discriminated price
# PRICE_DIFFERENCE_THRESHOLD=10
#
# How tax discrimination works:
# 1. Get product price from RMS (already without VAT)
# 2. Check if promotion is active on order's processed_at date
# 3. Compare with Shopify price (discriminated: shopify_price / 1.13)
# 4. If difference > PRICE_DIFFERENCE_THRESHOLD%, use Shopify price
# 5. Otherwise, use RMS price (with or without promotion)

# Category Tags and Collections (Optional)
# SYNC_INCLUDE_CATEGORY_TAGS: Agrega tags de categoría y género para collections automáticas
# SYNC_ENABLE_COLLECTIONS: Habilita sincronización de collections por género y categoría
# Recomendado: false (control manual sobre tags y collections en Shopify)
SYNC_INCLUDE_CATEGORY_TAGS=false
SYNC_ENABLE_COLLECTIONS=false

# === REVERSE STOCK SYNCHRONIZATION (Shopify → RMS) ===
# Sincronización complementaria que actualiza productos en Shopify que no fueron
# sincronizados en la última ejecución de RMS → Shopify
#
# Flujo de trabajo:
# 1. RMS → Shopify sync agrega tag "RMS-SYNC-2025-01-11"
# 2. Después de REVERSE_SYNC_DELAY_MINUTES, ejecuta reverse sync
# 3. Busca productos SIN tag de hoy
# 4. Consulta stock real en RMS
# 5. Actualiza inventario en Shopify
# 6. Elimina variantes con stock 0 (opcional)

# Habilitar sincronización reversa de stock
ENABLE_REVERSE_STOCK_SYNC=true

# Minutos de espera después de RMS→Shopify antes de ejecutar reverse sync
REVERSE_SYNC_DELAY_MINUTES=5

# Eliminar variantes con stock 0 durante reverse sync
REVERSE_SYNC_DELETE_ZERO_STOCK=true

# Número de productos a procesar por batch en reverse sync
REVERSE_SYNC_BATCH_SIZE=50

# No eliminar la última variante de un producto (mantener al menos 1)
REVERSE_SYNC_PRESERVE_SINGLE_VARIANT=true
